<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Facility - Lithium Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="dashboard-container"> <!-- Removed container mt-4 -->
        <!-- Navigation Placeholder -->
        <div id="main-navigation" class="mb-4">
             <nav class="navbar navbar-expand-lg navbar-light bg-light rounded p-2">
                 <div class="container-fluid">
                     <a class="navbar-brand" href="#">âž• Add New Facility</a>
                     <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                         <span class="navbar-toggler-icon"></span>
                     </button>
                     <div class="collapse navbar-collapse" id="navbarNav">
                         <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                             <li class="nav-item"><a class="nav-link" href="index.html">Map</a></li>
                             <li class="nav-item"><a class="nav-link" href="facilities.html">Facilities</a></li>
                             <li class="nav-item"><a class="nav-link" href="charts.html">Charts</a></li>
                             <li class="nav-item"><a class="nav-link" href="documents.html">Documents</a></li> <!-- Added Documents Link -->
                         </ul>
                         <div id="authStatus" class="d-flex">
                             <!-- Login/Logout status will be loaded here -->
                         </div>
                     </div>
                 </div>
             </nav>
        </div>
        <div id="main-content">

        <div class="card mb-3">
            <div class="card-header">Load from GeoJSON File</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="geojsonFile" class="form-label">Select GeoJSON Feature File (.geojson, .json)</label>
                    <input class="form-control" type="file" id="geojsonFile" accept=".geojson,.json">
                </div>
                <div id="geojsonStatus" class="form-text"></div> <!-- Area for upload status messages -->
            </div>
        </div>

         <div class="d-flex justify-content-between align-items-center mb-4">
             <h3>Add New Facility Details</h3>
             <a href="index.html" id="cancelButtonNew" class="btn btn-outline-secondary"><i class="fas fa-times"></i> Cancel</a>
         </div>

        <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
        <div id="successMessage" class="alert alert-success d-none" role="alert"></div>

        <form id="newFacilityForm">
            <div class="card mb-3">
                <div class="card-header">Basic Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="facilityName" class="form-label">Facility Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="facilityName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="facilityId" class="form-label">Facility ID (Optional - auto-generated if blank)</label>
                            <input type="text" class="form-control" id="facilityId" placeholder="e.g., company-location">
                             <div class="form-text">Use lowercase letters, numbers, and hyphens only.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="company" class="form-label">Company</label>
                            <input type="text" class="form-control" id="company">
                        </div>
                         <div class="col-md-6">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="Operating" selected>Operating</option>
                                <option value="Under Construction">Under Construction</option>
                                <option value="Planned">Planned</option>
                                <option value="Pilot">Pilot</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" placeholder="Street, City, State/Province, Country">
                        </div>
                         <div class="col-md-6">
                            <label for="region" class="form-label">Region</label>
                            <input type="text" class="form-control" id="region" placeholder="e.g., Southeast, Midwest, Canada">
                        </div>
                        <div class="col-md-6">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" value="USA">
                        </div>
                    </div>
                </div>
            </div>

             <div class="card mb-3">
                <div class="card-header">Location (Coordinates)</div>
                <div class="card-body">
                     <div class="row g-3">
                         <div class="col-md-6">
                            <label for="longitude" class="form-label">Longitude <span class="text-danger">*</span></label>
                            <input type="number" step="any" class="form-control" id="longitude" required placeholder="-87.611">
                         </div>
                         <div class="col-md-6">
                             <label for="latitude" class="form-label">Latitude <span class="text-danger">*</span></label>
                            <input type="number" step="any" class="form-control" id="latitude" required placeholder="33.232">
                         </div>
                     </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Technical Details</div>
                <div class="card-body">
                     <div class="row g-3">
                         <div class="col-md-6">
                            <label for="capacity" class="form-label">Processing Capacity</label>
                            <input type="text" class="form-control" id="capacity" placeholder="e.g., 10,000 tonnes per year">
                        </div>
                         <div class="col-md-6">
                            <label for="technology" class="form-label">Technology</label>
                            <input type="text" class="form-control" id="technology" placeholder="e.g., Hydrometallurgical process">
                        </div>
                         <div class="col-md-6">
                            <label for="yearStarted" class="form-label">Year Started / Planned</label>
                            <input type="number" class="form-control" id="yearStarted" placeholder="e.g., 2023">
                        </div>
                         <div class="col-md-6">
                            <label for="size" class="form-label">Facility Size</label>
                            <input type="text" class="form-control" id="size" placeholder="e.g., 150,000 square feet">
                        </div>
                         <div class="col-12">
                            <label for="feedstock" class="form-label">Feedstock</label>
                            <input type="text" class="form-control" id="feedstock" placeholder="e.g., Manufacturing scrap and end-of-life batteries">
                        </div>
                         <div class="col-12">
                            <label for="products" class="form-label">Output Products</label>
                            <input type="text" class="form-control" id="products" placeholder="e.g., Black mass, Cathode materials">
                        </div>
                         <div class="col-12">
                             <label for="technologyDetails" class="form-label">Technology Details</label>
                             <textarea class="form-control" id="technologyDetails" rows="3"></textarea>
                         </div>
                     </div>
                </div>
            </div>

             <div class="card mb-3">
                <div class="card-header">Description & Media</div>
                <div class="card-body">
                     <div class="row g-3">
                         <div class="col-12">
                            <label for="description" class="form-label">Facility Description</label>
                            <textarea class="form-control" id="description" rows="5"></textarea>
                        </div>
                         <div class="col-md-6">
                            <label for="website" class="form-label">Website URL</label>
                            <input type="url" class="form-control" id="website" placeholder="https://...">
                        </div>
                         <div class="col-md-6">
                            <label for="companyLogo" class="form-label">Company Logo URL</label>
                            <input type="text" class="form-control" id="companyLogo" placeholder="e.g., images/logos/company.png">
                        </div>
                         <div class="col-md-6">
                            <label for="facilityImage" class="form-label">Facility Image URL</label>
                            <input type="text" class="form-control" id="facilityImage" placeholder="e.g., images/facilities/facility.jpg">
                        </div>
                         <div class="col-md-6">
                            <label for="fundingSource" class="form-label">Funding Source</label>
                            <input type="text" class="form-control" id="fundingSource" placeholder="e.g., Private investment, DOE grant">
                        </div>
                         <div class="col-12">
                             <label for="timeline" class="form-label">Timeline (JSON format)</label>
                             <textarea class="form-control" id="timeline" rows="4" placeholder='[{"year": "2023", "event": "Construction started"}, {"year": "2024", "event": "Operations begin"}]'></textarea>
                             <div class="form-text">Enter as a JSON array of objects, each with "year" and "event" keys.</div>
                         </div>
                     </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-4">Add Facility</button>
        </form>
    </div>
        </div> <!-- End main-content -->

    <script>
        // --- GeoJSON File Upload Handling ---
        const geojsonFileInput = document.getElementById('geojsonFile');
        const geojsonStatusDiv = document.getElementById('geojsonStatus');
        const facilityForm = document.getElementById('newFacilityForm');

        geojsonFileInput.addEventListener('change', handleGeoJSONUpload);

        function handleGeoJSONUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                geojsonStatusDiv.textContent = '';
                return;
            }

            geojsonStatusDiv.textContent = `Reading file: ${file.name}...`;
            geojsonStatusDiv.className = 'form-text text-info'; // Use Bootstrap text color classes

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const geojson = JSON.parse(content);

                    // Basic Validation: Check if it's a Feature object
                    if (geojson.type !== 'Feature' || typeof geojson.properties !== 'object' || typeof geojson.geometry !== 'object') {
                        throw new Error('Invalid GeoJSON format. File must contain a single GeoJSON Feature object.');
                    }

                    // Populate form fields
                    populateFormFromGeoJSON(geojson.properties, geojson.geometry);

                    geojsonStatusDiv.textContent = 'GeoJSON loaded successfully. Please review and complete the form.';
                    geojsonStatusDiv.className = 'form-text text-success';

                } catch (error) {
                    console.error("Error processing GeoJSON file:", error);
                    geojsonStatusDiv.textContent = `Error: ${error.message}`;
                    geojsonStatusDiv.className = 'form-text text-danger';
                    // Optionally clear the form or parts of it on error
                    // facilityForm.reset(); // Consider if resetting is desired on error
                }
            };

            reader.onerror = function() {
                console.error("Error reading file");
                geojsonStatusDiv.textContent = 'Error reading the selected file.';
                geojsonStatusDiv.className = 'form-text text-danger';
            };

            reader.readAsText(file);
        }

        function populateFormFromGeoJSON(properties, geometry) {
            // Map properties to form fields
            document.getElementById('facilityName').value = properties.name || '';
            document.getElementById('facilityId').value = properties.id || ''; // Allow manual override or auto-gen
            document.getElementById('company').value = properties.company || '';
            document.getElementById('address').value = properties.address || '';
            document.getElementById('status').value = properties.status || 'Operating'; // Default if missing
            document.getElementById('capacity').value = properties.capacity || '';
            document.getElementById('technology').value = properties.technology || '';
            document.getElementById('website').value = properties.website || '';
            // Handle yearStarted/yearPlanned based on status
            if (properties.status === 'Planned' && properties.yearPlanned) {
                document.getElementById('yearStarted').value = properties.yearPlanned || '';
            } else {
                document.getElementById('yearStarted').value = properties.yearStarted || '';
            }
            document.getElementById('region').value = properties.region || '';
            document.getElementById('country').value = properties.country || 'USA'; // Default if missing
            document.getElementById('companyLogo').value = properties.companyLogo || '';
            document.getElementById('facilityImage').value = properties.facilityImage || '';
            document.getElementById('feedstock').value = properties.feedstock || '';
            document.getElementById('products').value = properties.products || '';
            document.getElementById('fundingSource').value = properties.fundingSource || '';
            document.getElementById('size').value = properties.size || '';
            document.getElementById('technologyDetails').value = properties.technologyDetails || '';
            document.getElementById('description').value = properties.description || '';

            // Handle Timeline (stringify if present)
            if (properties.timeline && Array.isArray(properties.timeline)) {
                try {
                    document.getElementById('timeline').value = JSON.stringify(properties.timeline, null, 2); // Pretty print
                } catch (e) {
                    document.getElementById('timeline').value = ''; // Clear if stringify fails
                    console.warn("Could not stringify timeline data from GeoJSON:", e);
                }
            } else {
                document.getElementById('timeline').value = '';
            }

            // Handle Geometry (Coordinates)
            if (geometry && geometry.type === 'Point' && Array.isArray(geometry.coordinates) && geometry.coordinates.length >= 2) {
                document.getElementById('longitude').value = geometry.coordinates[0];
                document.getElementById('latitude').value = geometry.coordinates[1];
            } else {
                // Clear coordinates if geometry is invalid or missing
                document.getElementById('longitude').value = '';
                document.getElementById('latitude').value = '';
                console.warn("Geometry data missing or invalid in GeoJSON.");
            }
        }
        // --- End GeoJSON File Upload Handling ---


        // --- Authentication Check (Client-Side) ---
        // This check runs if the page is loaded directly (e.g., refresh, bookmark)
        // It ensures the user has a valid token before showing the form.
        // SPA navigation relies on the check in common.js when the header loads.
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            console.log("No auth token found in localStorage on direct load. Redirecting to login.");
            window.location.href = 'login.html'; // Redirect immediately
        } else {
             console.log("Auth token found in localStorage on direct load. Proceeding.");
             // If the token exists, we assume the user is logged in for this page.
             // A more robust check could involve verifying the token with an API endpoint,
             // but for now, presence is sufficient based on the existing app logic.
        }
        // --- End Authentication Check ---



        // --- Cancel Button Navigation ---
        const cancelButtonNew = document.getElementById('cancelButtonNew');
        if (cancelButtonNew) {
            cancelButtonNew.addEventListener('click', function(event) {
                event.preventDefault(); // Stop the default link behavior
                window.location.href = 'facilities.html'; // Navigate to the facilities list
            });
        }
        // --- End Cancel Button Navigation ---

        document.getElementById('newFacilityForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const errorMessageDiv = document.getElementById('errorMessage');
            const successMessageDiv = document.getElementById('successMessage');
            errorMessageDiv.classList.add('d-none');
            successMessageDiv.classList.add('d-none');

            // --- Gather data from form ---
            const properties = {
                name: document.getElementById('facilityName').value,
                id: document.getElementById('facilityId').value || undefined, // Let backend generate if blank
                company: document.getElementById('company').value || undefined,
                address: document.getElementById('address').value || undefined,
                status: document.getElementById('status').value,
                capacity: document.getElementById('capacity').value || undefined,
                technology: document.getElementById('technology').value || undefined,
                website: document.getElementById('website').value || undefined,
                yearStarted: document.getElementById('yearStarted').value || undefined, // Handle as string/number? API expects string for now
                region: document.getElementById('region').value || undefined,
                country: document.getElementById('country').value || undefined,
                companyLogo: document.getElementById('companyLogo').value || undefined,
                facilityImage: document.getElementById('facilityImage').value || undefined,
                feedstock: document.getElementById('feedstock').value || undefined,
                products: document.getElementById('products').value || undefined,
                fundingSource: document.getElementById('fundingSource').value || undefined,
                size: document.getElementById('size').value || undefined,
                // Add other simple fields here: investment, evEquivalent, rdCapabilities, companyDescription
                technologyDetails: document.getElementById('technologyDetails').value || undefined,
                description: document.getElementById('description').value || undefined,
            };

             // Handle potentially missing yearStarted if status is Planned
             if (properties.status === 'Planned' && properties.yearStarted) {
                 properties.yearPlanned = properties.yearStarted;
                 delete properties.yearStarted;
             } else if (properties.status !== 'Planned') {
                 delete properties.yearPlanned; // Ensure yearPlanned is not set if not Planned status
             }


            // Handle Timeline JSON
            let timelineArray = [];
            const timelineInput = document.getElementById('timeline').value.trim();
            if (timelineInput) {
                try {
                    timelineArray = JSON.parse(timelineInput);
                    if (!Array.isArray(timelineArray)) throw new Error("Timeline must be a JSON array.");
                    // Optional: Add validation for objects inside array (have year/event keys)
                } catch (e) {
                    errorMessageDiv.textContent = `Invalid Timeline JSON: ${e.message}`;
                    errorMessageDiv.classList.remove('d-none');
                    return;
                }
            }
            properties.timeline = timelineArray.length > 0 ? timelineArray : undefined;


            // Handle Geometry
            const longitude = parseFloat(document.getElementById('longitude').value);
            const latitude = parseFloat(document.getElementById('latitude').value);
            if (isNaN(longitude) || isNaN(latitude)) {
                 errorMessageDiv.textContent = 'Valid Longitude and Latitude are required.';
                 errorMessageDiv.classList.remove('d-none');
                 return;
            }
            const geometry = {
                type: "Point",
                coordinates: [longitude, latitude]
            };

            // Construct the full GeoJSON Feature object
            const newFacilityFeature = {
                type: "Feature",
                properties: properties,
                geometry: geometry
            };

            // --- Send data to API ---
            try {
                const response = await fetch('/api/facilities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Add the Authorization header
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(newFacilityFeature),
                });

                const result = await response.json();

                if (response.status === 201) { // Check for Created status
                    successMessageDiv.textContent = `Facility "${result.properties.name}" created successfully! Redirecting...`;
                    successMessageDiv.classList.remove('d-none');
                    // Optionally clear form
                    // document.getElementById('newFacilityForm').reset();
                    setTimeout(() => {
                        window.location.href = 'index.html'; // Redirect after a short delay
                    }, 2000);
                } else {
                    errorMessageDiv.textContent = result.message || `Error creating facility (Status: ${response.status}).`;
                    errorMessageDiv.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error submitting new facility:', error);
                errorMessageDiv.textContent = 'An unexpected error occurred. Please try again.';
                errorMessageDiv.classList.remove('d-none');
            }
        });

        // Removed redundant checkAuthStatus and handleLogout functions.
        // This logic is handled globally by js/common.js when the header loads.
        // The check at the top of this script handles direct page access.

    </script>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>
</body>
</html>